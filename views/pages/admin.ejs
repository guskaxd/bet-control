<%- include('../partials/header') %>

<h2>Painel de Administração de Usuários</h2>
<p>Aqui você pode definir e atualizar a data de expiração da assinatura de cada usuário.</p>

<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle">
    <thead class="thead-dark">
      <tr>
        <th>ID</th>
        <th>Email</th>
        <th>Tipo</th>
        <th>Assinatura Vence em</th>
        <th class="coluna-acoes">Ações</th>
      </tr>
    </thead>
    <tbody>
      <% usuarios.forEach(usuario => { %>
        <tr>
          <td><%= usuario.id %></td>
          <td><%= usuario.email %></td>
          <td>
            <%
              let corBadge = 'secondary';
              if (usuario.tipo_usuario === 'admin') corBadge = 'success';
              if (usuario.tipo_usuario === 'vitalicio') corBadge = 'info';
            %>
            <span class="badge bg-<%= corBadge %>"><%= usuario.tipo_usuario %></span>
          </td>
          
          <%# Coluna apenas para o formulário de data %>
          <td>
            <% if (usuario.tipo_usuario === 'cliente') { %>
              <form action="/admin/usuario/<%= usuario.id %>/atualizar" method="POST" class="d-flex gap-2">
                <input 
                  type="date" 
                  name="novaData" 
                  class="form-control form-control-sm"
                  style="min-width: 140px;"
                  value="<%= usuario.assinatura_expira_em ? new Date(usuario.assinatura_expira_em).toISOString().split('T')[0] : '' %>"
                  required 
                />
                <button type="submit" class="btn btn-primary btn-sm">Salvar</button>
              </form>
            <% } else { %>
              <span class="text-muted">—</span>
            <% } %>
          </td>

          <%# Coluna apenas para os botões de ação %>
          <td class="coluna-acoes">
            <div class="d-flex gap-2">
              
              <%# Botão de Excluir (primeiro) %>
              <form action="/admin/usuario/<%= usuario.id %>/excluir" method="POST" onsubmit="return confirm('Tem certeza que deseja excluir este usuário e todos os seus dados? Esta ação não pode ser desfeita.');">
                <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
              </form>

              <%# Botão para alterar tipo (segundo) %>
              <% if (usuario.tipo_usuario === 'cliente') { %>
                <form action="/admin/usuario/<%= usuario.id %>/definir-tipo" method="POST">
                  <input type="hidden" name="tipo" value="vitalicio">
                  <button type="submit" class="btn btn-info btn-sm">Vitalício</button>
                </form>
              <% } else if (usuario.tipo_usuario === 'vitalicio') { %>
                <form action="/admin/usuario/<%= usuario.id %>/definir-tipo" method="POST">
                  <input type="hidden" name="tipo" value="cliente">
                  <button type="submit" class="btn btn-secondary btn-sm">Normal</button>
                </form>
              <% } %>

            </div>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<%- include('../partials/footer') %>